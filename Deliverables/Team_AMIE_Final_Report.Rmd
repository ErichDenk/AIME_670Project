---
title: "Final Report"
author: "Team AMIE"
date: "4/25/2019"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
require(tidyverse)
require(caret)
require(recipes)
require(pdp)
require(here)
```

#Problem Statement and Background

In 2015, there were an estimated 1.1 million people living with HIV in the United States. In 2016, there were almost 40,000 new cases of HIV. 1 of 10 of new diagnoses in 2016 was attributable to injection drug use.  

So far, there is no known cure to HIV.The main treatment for HIV is a class of drugs called antiretrovirals. These drugs donâ€™t cure HIV, but they can reduce the amount of virus in the body of someone with HIV. However, antiretroviral drugs can cause severe side effects that can make some people stop taking them. 

Historically marginalized populations, such as men who have sex with men (sometimes referred to as MSM), people who inject drugs, sex workers, and African Americans, are disporportionally affected by HIV. There is also a cyclical relationship between stigma and HIV; people who experience stigma and discrimination are marginalized and made more vulnerable to HIV, while those living with HIV are more vulnerable to experiencing stigma and discrimination. Therefore, it is critical to implement HIV prevention interventions to protect these marginalized populations from exposure to HIV. 

Currently, the two main HIV prevention strategies in the U.S. are pre-exposure prophylaxis (PrEP) and Syringe service programs (SSPs).PrEP is the use of drugs for people who are HIV negative but who are also at high-risk of contracting HIV. The high-risk populations in include MSM, injuction drug users, and sex workers. 

Syringe services programs (SSPs), also referred to as needle exchange programs (NEPs) and syringe exchange programs (SEPs)  provide sterile needles and syringes to drug users and safely dispose of used needles and syringes as a preventative measure for HIV and other infections that are transmissible by blood. Many of these programs integrate other intervention strategies, such as testing, treatment, and counseling services. 

```{r, include=FALSE}
idu_dat <- read_csv("idu_dat.csv")

idu_plot <- 
  idu_dat%>%
  ggplot(mapping = aes(x = as.character(idu_dat$Year),
                       y = idu_dat$New.Diagnoses.IDU.Total.Cases))+
  geom_bar(stat ="identity", fill = "#008FD5", alpha = 0.8)+
    ggthemes::theme_fivethirtyeight()+
    theme(panel.background = element_blank(),
        panel.grid.major.x = element_blank(),
        plot.title = element_text(face = "bold", size = 14),
        plot.subtitle = element_text(face = "italic", size =10),
        plot.caption = element_text(face = "italic"))+
    labs(title = "The Needle and the Damage Done",
         subtitle = "HIV cases transmitted by Injection Drug Use are falling",
         caption = "Source: AidsVu")
```

*Two trends that brought our research question about*
```{r, include=FALSE}
SEP_plot <- idu_dat%>%
  mutate(Yes = if_else(Allowed == "Yes", 1, 0))%>%
  ggplot(aes(x = as.character(Year), y = Yes))+
  geom_bar(stat = "identity",fill = "#FF2700", alpha = 0.8)+
  ggthemes::theme_fivethirtyeight()+
  theme(panel.background = element_blank(),
        panel.grid.major.x = element_blank(),
        plot.title = element_text(face = "bold", size = 14),
        plot.subtitle = element_text(face = "italic", size =10),
        plot.caption = element_text(face = "italic"),)+
  labs(title = "States increasingly allowing \nSyringe Exchange Programs",
       subtitle = "SEPs, while controversial, are becoming a common policy tool",
       caption = "Source: Center for Disease Control")
```
```{r, fig.width=9, fig.height=4, fig.align='center'}
plots <- grid.arrange(idu_plot,SEP_plot, ncol = 2)
```
As of 2014, 33 states had explicitly banned SSPs, and the federal funding of SSPs was prohibited.  In 2016, the law was changed to allow jurisdictions to use federal funding to support certain components of SSPs, excluding the purchase of the actual syringe and needles (Weinmeyer 2016). Despite this new legal opportunity, SSPs remain a controversial topic with strong opposition. Opponents to SSPs believe that federal funding of these programs indicates approval of illegal drug use, will lead to an increase in drug use and will lessen the moral and logistical barrier of access for children to become users. Despite the research and evidence that has been presented to oppose these viewpoints, adequate SSPs are still not available. 

There is a need to understand the effectiveness of HIV prevention strategies in limiting transmission of HIV in high-risk areas and understand the potential of uptake of SSPs to decrease transmission among injection drug users (IDU) in areas where need for SSPs have not been met. 

Through analyzing data on new incidence of HIV (particularly the incidences due to IDU), information on legalization of SSPs by states, and locations and numbers of SSPs by states,this study explores the unmet need of the two prevention methods (SSP and PrEP) and predictors of when the state will legalize operations of SSPs.  

#Data 
HIV new diagnoses data is available from AidVu the Center for Diesease Control and Prevention (CDC). From the AidusVu data we used three separate sub-sources. The first is the statewide new diagnoses set. This is a fairly complete from 2008 to 2016, though some states do not report on given statisitcs and ocassional data is suprressed for confidentiality reasons. Variables include new diagnoses, new diagnoses rates, category of transmission, and demographic data by each category. Secondly, the PrEP data sets available show participation rates by state. This data set was used in mapping and to compare another policy intervention in the fight against AIDs. Thrid, Prevalence data was also used. This is different than the incidence/new diagnoses data in that it is not limited to new HIV cases, but looks at the total number of people livingg with HIV in the area. 

Our second main source was NASEN (North America Syringe Exchange Network). NASEN provides the most (though not completely) comprehensive list of SEPs. NASEN is a non-profit whose mission is to connect people to syringe exchange locations near them. This information was scraped to build a data set to show where SEPs are and how many are in each state.

Finally, we used the CDC's list of state laws that allow or mandate state sponsored syringe exchange programs. Using their citations of state statutes, a longitudinal dataset of State laws (allow or not) from 2008 to 2016 was created. 

#Research Design/Approach

The main question we wanted to answer was whether syringe exchange programs have made any impact on IDU-related HIV diagnoses. Policymakers and stakeholders should have a tool by whiich to begin to evaluate this question. We have built a dashboard to look at rates of new diagnoses through IDU while also looking at the prevalence of prevention policies such as Syringe Exchange Programs and PrEP. A series of interactive maps, tables, and graphs are a great way to allow staekholder to learn more about trends nationally and in their own communities. 

Additionally, one might wonder whether it can be predicted when a state allows SEPs. In an effort to answer this question, supervised machine learning techniques were used in an attempt to model the decision to have an SEP. If we know what factors are most important in anticipating a law, perhaps new diagnoses of a certain demographic group., then governemnts can be proactive ather than reactive in their sEP policy. 

#Methods and Tools
##Mapping and Shiny Apps
The dashboard is presented via a Shiny application. The Shiny app allows users to interact with the maps, tables, and graphs that we created. Rather than a static representation, Shiny allows users to be more involved in learning about these trends.

The maps were created with `urbanmappr` and state shapefiles...

###PrEP Data

###New Diagnoses Data

##Predicting State SEP Laws with Machine Learning
The `caret` package was the main driver of the machine learning portion of our project. First, the statewide new diagnoses data need to be combined with the data on state laws. Most of this data cleaning and wrangling was done with `tidyverse` packages like `dplyr` and `tidyr`. When possible, the pipe `%>%` was used regularly. Once cleaned, this data needed to be preprocessed with a recipe. Three different machine learning algorithms were experimented with. K-nearest neighbors (knn), regression trees, and random forests. As discussed below, the random forest was the most successful model and the strongest predictors were examined in more detail. To do so, we used the interactive nature of the `ggiraph` package. 

#Results & Discussion

From the machine learning perspective, the random forest model had the most predictive accuracy of the three models employed. A random forest model with extratrees and mtry = 32 correctly predicts the SEP law status in more than 80% of state-years.

More interestingly the most important factors in prediction were related to Hispanic incidence of HIV from IDU, Hispanic incidence of HIV and MSM/IDU, and incidence in those over 55 years and older. These and other factors are demonstrated in the interactive model (shown in static form) below. The year was given as most important factor, but this makes sense in that it is the last year available in the data set. 

```{r, include = FALSE}
require(wesanderson)
require(ggplot2)
require(ggiraph)
require(ggthemes)

pal1 <- wes_palette(name = "GrandBudapest2", 6, type = "continuous")
grab_varimp <- read_csv(here("R-markdown-Files/ggiraph.csv"))
```
```{r, fig.width=5,fig.height=5, fig.align='center'}
plot_varimp <- 
  grab_varimp %>% 
    mutate(keyword = fct_reorder(keyword,importance)) %>% 
    mutate(sum_report = str_glue('keyword: "{keyword}"\nImportance: {round(importance,2)}%')) %>% 
    top_n(10, importance) %>% 
    ggplot(aes(keyword,importance,
               fill=importance)) +
    geom_point() +
    geom_hline(aes(yintercept = max(importance)),color="grey20",size=1,alpha=.25) +
    geom_bar_interactive(aes(tooltip=sum_report),
                         stat="identity",color="grey10") + 
    coord_flip() +
    scale_fill_gradientn(colors = pal1) +
    theme_hc() +
    labs(y="Importance of the Feature in Predicting SEPs\n(higher values == more important)",
         x="Features")+
    theme(legend.position = "none",
          axis.title = element_text(family="serif",size=10),
          axis.text = element_text(family="serif",size=10)) -> plt_obj
  interactive_plot <- girafe(ggobj = plt_obj,width = 4,height=4)
  girafe_options(interactive_plot, opts_toolbar(position = "topleft"))

```